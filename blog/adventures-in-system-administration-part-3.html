<!doctype html>
<html lang="en-US">
  <head>
    <meta http-equiv="content-type" content="text/html; charset=utf-8" />
    <title>Adventures in system administration - Part 3</title>
    <meta name="description" content="" />
    <meta property="og:title" content="Adventures in system administration - Part 3" />
    <meta property="og:description" content="" />
    <meta property="og:image" content="" />
    <meta property="og:type" content="article" />
    <meta property="og:url" content="https://josephpetitti.com/blog/adventures-in-system-administration-part-3" />
    <meta name="viewport" content="initial-scale=1.0, maximum-scale=1.0, width=device-width, user-scalable=no" />
    <link rel="shortcut icon" href="icon.ico" type="image/x-icon">

    <link rel="stylesheet" href="../webfonts/fonts.css" type="text/css">
    <link href="../styles/dark.css" rel="stylesheet" type="text/css">
    <link href="../styles/blog.css" rel="stylesheet" type="text/css">
  </head>
  <body>

  <!-- Header -->
    <header class="article">
      <a id="home-button" href="../index" title="Home">
        Home
      </a>

      <a id="blog-index-button" href="../blog" title="Blog Index">
        Blog Index
      </a>
    </header>

  <!-- Main -->
    <main id="main" class="blog">

      <span class="date"><time datetime="2019-06-06">June 6, 2019</span>

      <h1 class="title">Adventures in system administration - Part 3</h1>

      <h2 id="step-3-organizing-the-network">Step 3: Organizing the network</h2>

      <p>
        This article will probably not apply to other setups, but I want to
        document it for the sake of thoroughness, and also in case I forget how
        I set stuff up in the future.
      </p>

      <h3 id="install-nginx">Install nginx</h3>
      
      <p>
        The first thing I did after getting the virtual network set up is to
        move my nginx reverse proxy from an old physical server to the R710.
        This reverse proxy allows me to run multiple web services from behind
        one public IPv4 address, using HTTP's name-based virtual hosting.
      </p>

      <p>
        Unfortunately, Foreman installs its own httpd (Apache) web server when
        it's installed, and getting nginx and Apache to play nice with each
        other is notoriously difficult. The first thing I had to do was free up
        the default HTTP and HTTPS ports from Apache's grasp.
      </p>

      <p>
        Apache's config files are located in <code>/etc/https/</code>. Edit
        <code>conf/ports.conf</code> and change the listen directives to use new
        ports. I chose these ones because they don't conflict with any of
        Foreman's other services:
      </p>

      <code class="block">Listen 4430
Listen 8080</code>

      <p>
        Next, you have to change the virtual server blocks in the
        <code>conf.d</code> folder. The two files we need to edit here are
        <code>05-foreman.conf</code> and <code>05-foreman-ssl.conf</code>,
        replacing all references to port 80 and 443 with our newly chosen ports.
      </p>

      <p>
        At this point you may think you can just restart httpd and everything
        will be good, but Apache will likely complain that it can't bind to the
        ports you chose. This is because SELinux is preventing it from doing so.
        You can check this with:
      </p>

      <code class="block"># semanage port -l | grep http</code>

      <p>
        The ports you chose will likely not be in the list of known http ports,
        so go ahead and add them with:
      </p>

      <code class="block"># semanage port -a -t http_port_t -p tcp <i>port</i></code>

      <p>
        Now you should be able to <code>systemctl restart httpd</code> and it'll
        come back up gracefully.
      </p>

      <p>Now, let's install and enable nginx.</p>
      
      <code class="block"># yum install nginx
# systemctl enable nginx
# systemctl start nginx</code>

      <p>You can verify that nginx has taken over port 80 with:</p>
      
      <code class="block"># curl -I localhost</code>

      <p>You should see something like this:</p>

      <code class="block">HTTP/1.1 200 OK
<span style="color: red">Server: nginx/1.12.2</span>
Date: Fri, 07 Jun 2019 1:10:57 GMT
Content-Type: text/html
...</code>

      <h3 id="configure-nginx">Configure nginx</h3>

      <p>
        Let's set up nginx as a secure and powerful reverse proxy. First, we'll
        add some system-wide settings to <code>/etc/nginx/nginx.conf</code>. The
        default configuration is pretty good, but let's enable gzip compression
        in the <code>http</code> block so our pages load a little faster:
      </p>

      <code class="block">gzip on;
gzip_vary on;
gzip_proxied any;
gzip_comp_level 6;
gzip_buffers 16 8k;
gzip_http_version 1.1;
gzip_min_length 256;
gzip_types text/plain text/css application/json application/x-javascript text/xml application/xml+rss text/javascript application/vnd.ms-fontobject application/x-font-ttf font/opentype image/svg+xml image/x-icon;</code>

      <p>
        We'll also add some security headers to all of our responses, and stop
        broadcasting the version number of nginx we're running.
      </p>

      <code class="block">server_tokens off;
add_header X-Frame-Options SAMEORIGIN;
add_header X-Content-Type-Options nosniff;
add_header X-XSS-Protection "1; mode=block";</code>

      <p>
        Finally, we want to use expires headers to enable browser caching, but
        we want to cache different assets for different periods of time. A map
        block here will allow us to include this easily in each of our site
        configs.
      </p>

      <code class="block">map $sent_http_content_type $expires {
    default    off;
    text/html              epoch;
    text/css               30d;
    application/javascript 30d;
    ~/image/               30d;
}</code>

    <p>
      Let's make a general-purpose site config file that we can copy for any
      future sites we want to enable in the future. I've already made one, and
      it can be seen <a href="../assets/nginx-default.txt">here</a>.
    </p>

    <p>
      The first site config we're going to install will simply proxy pass
      requests along to Apache so we can access Foreman again. The structure of
      this config is pretty straightforward, just include this snippet in the
      server block:
    </p>

    <code class="block">location / {
    proxy_pass https://192.168.1.25:4430;
    proxy_hide_header X-Powered-By;
    proxy_set_header Range $http_range;
    proxy_set_header If-Range $http_if_range;
    proxy_set_header X-Real-IP $remote_addr;
    proxy_set_header Host $host;
    proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
}</code>
    
    <p>
      If you like forcing HTTPS (as you should), certbot makes it super easy to
      get TLS certificates.
    </p>

    <code class="block"># yum install python-certbot-nginx
# certbot --nginx -d <i>foreman.example.com</i></code>


    </main>

  <!-- Footer -->
    <footer id="footer" class="article">
      <section class="about">
        <h2>About this website</h2>

        <p>
          I created this website as a personal project in my free time to learn
          more about web design, CSS, HTML, and JavaScript.
        </p>

        <p>
          All portions of this website written by me are released under the 
          <a href="../license.txt"> MIT License</a>.  Other scripts and resources
          are licensed under free licenses by their respective owners. All
          source code is available on 
          <a href="https://github.com/jojonium/josephpetitti.com"> GitHub</a>.
        </p>
      </section>

  </body>
</html>
