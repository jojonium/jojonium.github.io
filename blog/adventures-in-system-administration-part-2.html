<!doctype html>
<html lang="en-US">
  <head>
    <meta http-equiv="content-type" content="text/html; charset=utf-8" />
    <title>Adventures in system administration - Part 2</title>
    <meta name="description" content="" />
    <meta property="og:title" content="Adventures in system administration - Part 2" />
    <meta property="og:description" content="" />
    <meta property="og:image" content="https://josephpetitti.com/blog/images/r710.jpg" />
    <meta property="og:type" content="article" />
    <meta property="og:url" content="https://josephpetitti.com/blog/adventures-in-system-administration-part-2" />
    <meta name="viewport" content="initial-scale=1.0, maximum-scale=1.0, width=device-width, user-scalable=no" />
    <link rel="shortcut icon" href="icon.ico" type="image/x-icon">

    <link rel="stylesheet" href="../webfonts/fonts.css" type="text/css">
    <link href="../styles/dark.css" rel="stylesheet" type="text/css">
    <link href="../styles/blog.css" rel="stylesheet" type="text/css">
  </head>
  <body>

  <!-- Header -->
    <header class="article">
      <a id="home-button" href="../index" title="Home">
        Home
      </a>

      <a id="blog-index-button" href="../blog" title="Blog Index">
        Blog Index
      </a>
    </header>

  <!-- Main -->
    <main id="main" class="blog">

      <span class="date"><time datetime="2019-05-28">May 28, 2019</span>

      <h1 class="title">Adventures in system administration - Part 2</h1>

      <h2 id="step-2-creating-virtual-machines">
        Step 2: Creating virtual machines
      </h2>

      <p>
        We're almost ready to start creating virtual servers with Foreman. We
        need to get Foreman and Libvirt to talk to each other first, which
        requires a little extra work. First, install the foreman-libvirt package
        like so:
      </p>

      <code class="block"># yum install foreman-libvirt</code>

      <p>Restart your physical server so everything refreshes:</p>

      <code class="block"># reboot</code>

      <p>
        Once it comes back online, you should be able to go to Foreman's web
        interface and set up a Libvirt compute resource. But before we do that,
        we need to make our Libvirt trust Foreman.
      </p>

      <code class="block">root@box# su foreman -s /bin/bash
foreman@box$ ssh-keygen
foreman@box$ ssh-copy-id root@host.example.com</code>

      <p>
        You can leave Foreman user's SSH key in the default location and leave
        the password blank if you want. When prompted, enter the root password
        to copy SSH IDs. At this point, while logged in as <code>foreman</code>
        you should be able to execute:
      </p>

      <code class="block">foreman@box$ ssh root@host.example.com</code>

      <p>to get into a superuser shell. As the final test, try executing:</p>

      <code class="block">foreman@box$ virsh -c qemu+ssh://root@host.example.com/system list</code>
      
      <p>
        If you did everything right up to here it should work without error. Now
        return to the Foreman web interface. Go to <i>Infrastructure &gt;
        Compute Resources</i> and click the big blue "Create" button. Pick a
        cool-sounding name, and choose Libvirt from the Provider menu. For the
        URL, use:
      </p>

      <code class="block">qemu+ssh://root@host.example.com/system</code>

      <p>
        As a final sanity test you can try the "Test Connection" button. If
        everything looks good click "Submit" and you should be all good.
      </p>

      <h3 id="more-foreman-administration">More Foreman administration</h3>

      <p>
        There are a few more things we need to set up before we can start
        conjuring VMs out of thin air.
      </p>

      <p>
        Make sure you have a Libvirt storage pool with 
        <code>virsh pool-list</code>. If you don't already have an active pool
        with autostart turned on, create one like so:
      </p>

      <code class="block"># virsh pool-define-as --name <i>default</i> --type dir \
--target /path/of/your/choice
# virsh pool-autostart <i>default</i>
# virsh pool-start <i>default</i></code>

      <p>
        Next, we want to make a provisioning template so all of our virtual
        machines are set up basically the same. Foreman comes with a few helpful
        example templates to get you started, so we'll just copy one of those to
        work with.
      </p>

      <p>
        Go to <i>Hosts &gt; Provisioning Templates</i> and find the template
        called "Kickstart default PXELinux." Use the action button to clone it,
        and start editing the clone. Give this template whatever name you want,
        then head over to the Association tab to make sure it's associated with
        our CentOS 7.6 operating system (Foreman automagically knows about this
        OS because it knows what it's installed on). Make sure you click
        "Submit" once you're done.
      </p>

      <p>
        Now go to <i>Hosts &gt; Operating Systems</i> and edit CentOS 7.6. Under
        the Templates tab set the template we just made as the PXELinux template
        for this operating system and hit Submit.
      </p>

      <p>
        While still editing the CentOS 7.6 operating system, switch to the
        Partition Table tab. Associate the included "kickstart default"
        partition table with this OS.
      </p>

      <h3 id="setting-up-dhcp">Setting up DHCP</h3>

      <p>
        Our next step is to set up a DHCP server for our virtual network, using
        Foreman and Libvirt. Edit the default Libvirt network with
        <code>virsh net-edit default</code> so that it looks like this:
      </p>

      <code class="block">&lt;network&gt;
  &lt;name&gt;default&lt;/name&gt;
  &lt;uuid&gt;c9c73310-bd3c-4d04-a758-11bc905edd17&lt;/uuid&gt;
  &lt;forward mode='nat'/&gt;
  &lt;bridge name='virbr0' stp='on' delay='0'/&gt;
  &lt;domain name="virtnet" /&gt;
  &lt;dns&gt;
  &lt;/dns&gt;
  &lt;mac address='52:54:00:7e:be:1c'/&gt;
  &lt;ip address='192.168.122.1' netmask='255.255.255.0'&gt;
    &lt;tftp root='var/tftproot' /&gt;
    &lt;dhcp&gt;
      &lt;range start='192.168.122.2' end='192.168.122.254'/&gt;
      &lt;bootp file='pxelinux.0' /&gt;
    &lt;/dhcp&gt;
  &lt;/ip&gt;
&lt;/network&gt;</code>

      <p>
        Make a TFTP root directory, make sure it is writeable by the 
        <code>foreman-proxy</code> user and accessible to the accoung dnsmasq is
        running on (<code>nobody</code>), set the gid flag for newly copied
        files and copy necessary files to the new TFTP root directory:
      </p>

      <code class="block"># mkdir -p /var/tftproot/{boot,pxelinux.cfg}
# yum -y install syslinux
# cp /usr/share/syslinux/{pxelinux.0,menu.c32,chain.c32} /var/tftproot
# chown -R foreman-proxy:nobody /var/tftproot
# find /var/tftproot/ -type d | xargs chmod g+s</code>

      <p>
        Next, edit <code>/etc/libvirt/libvirtd.conf</code> and uncomment these
        lines to allow <code>foreman-proxy</code> to be able to connect to the
        libvirt daemon.
      </p>

      <code class="block">unix_sock_group = "foreman-proxy"
unix_sock_rw_perms = "0770"</code>

      <p>
        Next, cd into <code>/etc/foreman-proxy/settings.d</code>. There are a
        few config files we need to edit.
      </p>

      <p>
        Put these in <code>tftp.yml</code>:
      </p>

      <code class="block">:tftp: true
:tftproot: /var/tftproot
:tftp_servername: 192.168.122.1</code>

      <p>
        In <code>dns.yml</code>:
      </p>

      <code class="block">:enabled: true
:use_provider: dns_libvirt</code>

      <p>
        In <code>dhcp.yml</code>:
      </p>

      <code class="block">:enabled: true
:use_provider: dhcp_libvirt</code>

      <p>
        And in <code>dns_libvirt.yml</code> and <code>dhcp_libvirt.yml</code>:
      </p>

      <code class="block">:etwork: default
:url: qemu:///system</code>

      <p>
        Now we're finally ready to create our first virtual machine!
      </p>

      <h3 id="into-the-virtual-world">Into the virtual world</h3>

      <p>
        Let's go ahead and create our first virtual server. Go to <i>Hosts &gt;
        Create Host</i> and enter a cool name. Make the Organization and
        Location default, and make sure you choose the Libvirt compute module
        you configured earlier instead of Bare Metal for what to deploy on.
        Configure the Virtual Machine tab however you want. I want this host to
        be an LDAP server, so I think I can leave it with the default 1 CPU and
        2 GB of memory. Under Storage, you should see the virsh pool you created
        earlier. Choose how big you want your virtual hard drive to be, I picked
        20 GB just to be safe. If you change the type to QCOW2 the file that
        represents the virtual disk will grow as it's needed, so it's not the
        full 20 GB unless it's totally full.
      </p>

      <figure class="full-width">
        <a href="images/create-host.png">
          <img src="images/th_create-host.png" alt="This is what the Virtual Machine tab should look like">
        </a>
      </figure>

      <p>
        Under the Operating System tab, we're going to pick x86_64 as the
        architecture and CentOS 7.6.1810 as the operating system. For media
        choose the default CentOS mirror. Select the partition table you
        configured earlier, and the PXE loader will be PXELinux BIOS.  Make suer
        you set a strong root password too. If you clidk "Resolve" the
        provisioning template we configured earlier should show up.
      </p>

      <figure class="full-width">
        <a href="images/create-host-os.png">
          <img src="images/th_create-host-os.png" alt="This is what the Operating System tab should look like">
        </a>
      </figure>

      <p>
        You can configure the interface to assign a specific IP address if you
        want, but if not that's it.
      </p>
        

    </main>

  <!-- Footer -->
    <footer id="footer" class="article">
      <section class="about">
        <h2>About this website</h2>

        <p>
          I created this website as a personal project in my free time to learn
          more about web design, CSS, HTML, and JavaScript.
        </p>

        <p>
          All portions of this website written by me are released under the 
          <a href="../license.txt"> MIT License</a>.  Other scripts and resources
          are licensed under free licenses by their respective owners. All
          source code is available on 
          <a href="https://github.com/jojonium/josephpetitti.com"> GitHub</a>.
        </p>
      </section>

  </body>
</html>
